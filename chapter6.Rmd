# Chapter 6: Analysis of longitudinal data

## Part 1: Implementing the analyses of Chapter 8 of MABS, using the RATS data

```{r}

# Getting the data set ready
library(dplyr)
library(tidyr)
library(ggplot2)

RATS <- read.table("https://raw.githubusercontent.com/KimmoVehkalahti/MABS/master/Examples/data/rats.txt", sep = "\t", header = T)

#Taking a look at the data
dim(RATS)
str(RATS)
names(RATS)
glimpse(RATS)
summary(RATS)

# Getting data in right form
RATS$ID <- factor(RATS$ID)
RATS$Group <- factor(RATS$Group)
RATSL <- pivot_longer(RATS, cols = -c(ID, Group), 
                      names_to = "WD",
                      values_to = "Weight") %>% 
  mutate(Time = as.integer(substr(WD,3,4))) %>%
  arrange(Time)

names(RATSL)

# Drawing a plot with `Time` on the x-axis and `Weight` on the y-axis

ggplot(RATSL, aes(x = Time, y = Weight, linetype = ID)) +
  geom_line() +
  scale_linetype_manual(values = rep(1:10, times=4)) +
  facet_grid(. ~ Group, labeller = label_both) +
  theme(legend.position = "none") + 
  scale_y_continuous(limits = c(min(RATSL$Weight), max(RATSL$Weight)))

```

```{r}

# Redoing the graph with standardized data
RATSL1 <- RATSL %>%
  group_by(ID) %>%
  mutate(stdweight = (Weight - mean(Weight))/sd(Weight) ) %>%
  ungroup()

summary(RATSL1)

ggplot(RATSL1, aes(x = Time, y = stdweight, linetype = ID)) +
  geom_line() +
  scale_linetype_manual(values = rep(1:10, times=4)) +
  facet_grid(. ~ Group, labeller = label_both) +
  theme(legend.position = "none") + 
  scale_y_continuous(limits = c(min(RATSL1$stdweight), max(RATSL1$stdweight)))



```


```{r}
# Creating a summary graphs for non-standardized and standardized data with mean and standard error of weight by Group and Time

# Non-standardized
n <- 16
RATSS <- RATSL %>%
  group_by(Group, Time) %>%
  summarise( mean = mean(Weight), se = sd(Weight)/n^0.5 ) %>%
  ungroup()

# Plotting the mean profiles
library(ggplot2)
ggplot(RATSS, aes(x = Time, y = mean, linetype = Group, shape = Group)) +
  geom_line() +
  scale_linetype_manual(values = c(1,2,3)) +
  geom_point(size=3) +
  scale_shape_manual(values = c(1,2,3)) +
  geom_errorbar(aes(ymin=mean-se, ymax=mean+se, linetype="1"), width=0.3) +
  theme(legend.position = c(0.8,0.8)) +
  scale_y_continuous(name = "mean(weight) +/- se(weight)")


# Standardized
n <- 16
RATSS1 <- RATSL1 %>%
  group_by(Group, Time) %>%
  summarise( mean = mean(stdweight), se = sd(stdweight)/n^0.5 ) %>%
  ungroup()

# Plotting the mean profiles
ggplot(RATSS1, aes(x = Time, y = mean, linetype = Group, shape = Group)) +
  geom_line() +
  scale_linetype_manual(values = c(1,2,3)) +
  geom_point(size=3) +
  scale_shape_manual(values = c(1,2,3)) +
  geom_errorbar(aes(ymin=mean-se, ymax=mean+se, linetype="1"), width=0.3) +
  theme(legend.position = c(0.8,0.8)) +
  scale_y_continuous(name = "mean(weight) +/- se(weight)")

```


```{r}
# Looking for an outlier in standardized data

# Create a summary data by group and ID with mean as the summary variable (ignoring baseline Time 1)
RATSLS <- RATSL1 %>%
  filter(Time > 1) %>%
  group_by(Group, ID) %>%
  summarise( mean=mean(stdweight) ) %>%
  ungroup()

# Glimpse the data
glimpse(RATSLS)

# Drawing a boxplot of the mean versus group
ggplot(RATSLS, aes(x = Group, y = mean)) +
  geom_boxplot() +
  stat_summary(fun = "mean", geom = "point", shape=23, size=4, fill = "white") +
  scale_y_continuous(name = "mean(weight)")

# Excluding the outliers
RATSLS1 <- RATSLS %>%
  filter(mean > 0.02)

# Drawing a boxplot without the outlier
ggplot(RATSLS1, aes(x = Group, y = mean)) +
  geom_boxplot() +
  stat_summary(fun = "mean", geom = "point", shape=23, size=4, fill = "white") +
  scale_y_continuous(name = "mean(weight)")


```




```{r}
# Looking for an outlier in non-standardized data

# Create a summary data by group and ID with mean as the summary variable (ignoring baseline Time 1)
RATSLS_ <- RATSL %>%
  filter(Time > 1) %>%
  group_by(Group, ID) %>%
  summarise( mean=mean(Weight) ) %>%
  ungroup()

# Glimpse the data
glimpse(RATSLS_)

# Drawing a boxplot of the mean versus group
ggplot(RATSLS_, aes(x = Group, y = mean)) +
  geom_boxplot() +
  stat_summary(fun = "mean", geom = "point", shape=23, size=4, fill = "white") +
  scale_y_continuous(name = "mean(weight)")

# Excluding the outliers
RATSLS1_ <- RATSLS_ %>%
  filter(mean < 550)

# Drawing a boxplot without the outlier
ggplot(RATSLS1_, aes(x = Group, y = mean)) +
  geom_boxplot() +
  stat_summary(fun = "mean", geom = "point", shape=23, size=4, fill = "white") +
  scale_y_continuous(name = "mean(weight)")


```


```{r}
# Performing a T test and Anova 

library(dplyr); library(tidyr)

# Performing t test reguires that there are two groups that are compared. Thus, t test is performed for group 1 against group 2+3
RATSLS2 <- RATSLS_ %>% mutate(GroupT = c(1, 1, 1, 1, 1, 1, 1, 1, 2, 2, 2, 2, 2, 2, 2, 2))
glimpse(RATSLS2)

# t-test
t.test(mean ~ GroupT, data = RATSLS2, var.equal = TRUE)

# Adding the baseline from the original data as a new variable to the summary data
RATSLS3 <- RATSLS_ %>%
  mutate(baseline = RATS$WD1)
glimpse(RATSLS3)

# Fiting the linear model with the mean as the response 
fit <- lm(mean ~ baseline + Group, data = RATSLS3)

# Compute the analysis of variance table for the fitted model with anova()
anova(fit)


```


##  Part 2: Implement the analyses of Chapter 9 of MABS for BRPS


```{r}
# Getting the BRPS data set ready
BPRS  <- read.table("https://raw.githubusercontent.com/KimmoVehkalahti/MABS/master/Examples/data/BPRS.txt", sep = " ", header = T)

#Taking a look at the data
dim(BPRS)
str(BPRS)
names(BPRS)
glimpse(BPRS)
summary(BPRS)

# In BPRS categorical variables include treatment and subject
BPRS$treatment <- factor(BPRS$treatment)
BPRS$subject <- factor(BPRS$subject)

# Converting the data sets to long form. Adding a week variable to BPRS.
BPRSL <-  pivot_longer(BPRS, cols = -c(treatment, subject),
                       names_to = "weeks", values_to = "bprs") %>%
  arrange(weeks) 
BPRSL <-  BPRSL %>% 
  mutate(week = as.integer(substr(weeks, 5, 5)))

glimpse(BPRSL)

```
```{r}
# Drawing a plot to visualize the data

library(ggplot2)
ggplot(BPRSL, aes(x = week, y = bprs, linetype = subject)) +
  geom_line() +
  scale_linetype_manual(values = rep(1:10, times=4)) +
  facet_grid(. ~ treatment, labeller = label_both) +
  theme(legend.position = "none") + 
  scale_y_continuous(limits = c(min(BPRSL$bprs), max(BPRSL$bprs)))



```


```{r}

# Linear regression model BPRS_reg
BPRS_reg <- lm(bprs ~ week + treatment, data = BPRSL)

# print out a summary of the model
summary(BPRS_reg)

# Commentary ...
```
```{r}

# The Random Intercept Model
library(lme4)

# Creating a random intercept model
BPRS_ref <- lmer(bprs ~ treatment + week + (1 | subject), data = BPRSL, REML = FALSE)

# Print the summary of the model
summary(BPRS_ref)

# Commentary ...
```

```{r}
# Random Intercept and Random Slope Model

BPRS_ref1 <- lmer(bprs ~ week + treatment + (week | subject), data = BPRSL, REML = FALSE)

# Printing a summary of the model
summary(BPRS_ref1)

# perform an ANOVA test on the two models
anova(BPRS_ref1, BPRS_ref)

# Commentary ...

```

```{r}
# Random Intercept and Random Slope Model with interaction

BPRS_ref2 <- lmer(bprs ~ week + treatment + week*treatment + (week | subject), data = BPRSL, REML = FALSE)

# print a summary of the model
summary(BPRS_ref2)

# perform an ANOVA test on the two models
anova(BPRS_ref2, BPRS_ref1)

# Create a vector of the fitted values
Fitted <- fitted(BPRS_ref2)
summary(Fitted)

# Create a new column fitted to RATSL
BPRSL <-  BPRSL %>% 
            mutate(fitted = Fitted )

summary(RATSL$fitted)

# Draw plot with observed data
ggplot(BPRSL, aes(x = week, y = bprs, linetype = subject)) +
  geom_line() +
  scale_linetype_manual(values = rep(1:10, times=4)) +
  facet_grid(. ~ treatment, labeller = label_both) +
  theme(legend.position = "none") + 
  scale_y_continuous(name = "observed bprs", limits = c(min(BPRSL$bprs), max(BPRSL$bprs)))

# Draw a plot with fitted values
ggplot(BPRSL, aes(x = week, y = fitted, linetype = subject)) +
  geom_line() +
  scale_linetype_manual(values = rep(1:10, times=4)) +
  facet_grid(. ~ treatment, labeller = label_both) +
  theme(legend.position = "none") + 
  scale_y_continuous(name = "Fitted bprs", limits = c(min(BPRSL$bprs), max(BPRSL$bprs)))

# Commentary ...

```


# End 


```{r}
date()
```
